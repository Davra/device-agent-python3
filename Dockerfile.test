# Multi-stage Dockerfile for testing Davra Agent installation
# Supports multiple OS versions and test scenarios

ARG OS_VERSION=ubuntu:22.04
FROM ${OS_VERSION}

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install basic requirements
RUN apt-get update && apt-get install -y \
    curl \
    tar \
    sudo \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*


RUN apt-get update && \
    apt-get install -y systemd systemd-sysv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a test directory
WORKDIR /test

# Copy the agent source files
COPY davra-agent/ /test/davra-agent/
COPY build.sh /test/


# Make scripts executable
RUN chmod +x /test/davra-agent/install.sh \
    && chmod +x /test/build.sh ;

# Create build directory
RUN mkdir -p /test/build

RUN /test/build.sh

# Default command runs verification after install
CMD ["/bin/bash", "-c", "echo 'Docker test container ready. Run install.sh to test.'"]
